<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agentify.js - Chat History Ù…Ø¯ÛŒØ±ÛŒØª</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #2193b0 0%, #6dd5ed 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2193b0 0%, #6dd5ed 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .content {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 0;
            min-height: 700px;
        }

        .sidebar {
            background: #f8f9fa;
            padding: 20px;
            border-left: 1px solid #e9ecef;
            overflow-y: auto;
        }

        .main {
            padding: 20px;
            display: flex;
            flex-direction: column;
        }

        .chat-list {
            margin-bottom: 20px;
        }

        .chat-item {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .chat-item:hover {
            border-color: #2193b0;
            transform: translateX(-5px);
        }

        .chat-item.active {
            border-color: #2193b0;
            background: #e7f5ff;
        }

        .chat-item-title {
            font-weight: bold;
            color: #2193b0;
            margin-bottom: 5px;
            font-size: 13px;
        }

        .chat-item-info {
            font-size: 11px;
            color: #6c757d;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #2193b0 0%, #6dd5ed 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-value {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 12px;
            opacity: 0.9;
        }

        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-box {
            flex: 1;
            overflow-y: auto;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            background: #f8f9fa;
            min-height: 400px;
        }

        .message {
            margin-bottom: 15px;
            padding: 12px 16px;
            border-radius: 12px;
            max-width: 70%;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.user {
            background: linear-gradient(135deg, #2193b0 0%, #6dd5ed 100%);
            color: white;
            margin-right: auto;
            border-bottom-right-radius: 4px;
        }

        .message.assistant {
            background: white;
            border: 2px solid #e9ecef;
            margin-left: auto;
            border-bottom-left-radius: 4px;
        }

        .message-time {
            font-size: 10px;
            opacity: 0.7;
            margin-top: 5px;
        }

        .input-section {
            display: flex;
            gap: 10px;
        }

        .input-section input {
            flex: 1;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
        }

        button {
            padding: 12px 24px;
            background: linear-gradient(135deg, #2193b0 0%, #6dd5ed 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        button.secondary {
            background: #6c757d;
        }

        button.danger {
            background: #dc3545;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .controls button {
            flex: 1;
            font-size: 12px;
            padding: 8px 12px;
        }

        .settings-box {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .settings-box h4 {
            margin-bottom: 10px;
            color: #856404;
        }

        .setting-item {
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .setting-item label {
            font-size: 13px;
            color: #856404;
        }

        .setting-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
        }

        .setting-item input[type="number"] {
            width: 80px;
            padding: 5px;
            border: 2px solid #ffc107;
            border-radius: 4px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }

        .empty-state h3 {
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ’¬ Ù…Ø¯ÛŒØ±ÛŒØª ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ú†Øªâ€ŒÙ‡Ø§</h1>
            <p>Ø°Ø®ÛŒØ±Ù‡ Ùˆ Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ú©Ø§Ù…Ù„ Ú¯ÙØªÚ¯ÙˆÙ‡Ø§</p>
        </div>

        <div class="content">
            <div class="sidebar">
                <h3 style="margin-bottom: 15px; color: #2193b0;">ğŸ“‹ Ú†Øªâ€ŒÙ‡Ø§ÛŒ Ù…Ù†</h3>
                
                <div class="controls">
                    <button onclick="createNewChat()">Ú†Øª Ø¬Ø¯ÛŒØ¯</button>
                    <button class="secondary" onclick="refreshChatList()">ğŸ”„</button>
                </div>

                <div class="settings-box">
                    <h4>âš™ï¸ ØªÙ†Ø¸ÛŒÙ…Ø§Øª</h4>
                    <div class="setting-item">
                        <input type="checkbox" id="useHistory" checked onchange="updateSettings()">
                        <label>Ø°Ø®ÛŒØ±Ù‡ ØªØ§Ø±ÛŒØ®Ú†Ù‡</label>
                    </div>
                    <div class="setting-item">
                        <input type="checkbox" id="includeHistory" checked onchange="updateSettings()">
                        <label>Ø§Ø±Ø³Ø§Ù„ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø¨Ù‡ Ù…Ø¯Ù„</label>
                    </div>
                    <div class="setting-item">
                        <label>Ø­Ø¯Ø§Ú©Ø«Ø± Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§:</label>
                        <input type="number" id="maxHistory" value="50" onchange="updateSettings()">
                    </div>
                </div>

                <div class="chat-list" id="chatList">
                    <p style="text-align: center; color: #6c757d; padding: 20px;">
                        Ú†ØªÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯...
                    </p>
                </div>
            </div>

            <div class="main">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="totalChats">0</div>
                        <div class="stat-label">Ú©Ù„ Ú†Øªâ€ŒÙ‡Ø§</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalMessages">0</div>
                        <div class="stat-label">Ú©Ù„ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="currentMessages">0</div>
                        <div class="stat-label">Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ ÙØ¹Ù„ÛŒ</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="storageUsed">0 KB</div>
                        <div class="stat-label">ÙØ¶Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø´Ø¯Ù‡</div>
                    </div>
                </div>

                <div class="chat-container">
                    <div class="chat-header">
                        <div>
                            <strong id="currentChatTitle">Ú†Øª ÙØ¹Ù„ÛŒ</strong>
                            <span id="currentChatId" style="font-size: 11px; color: #6c757d; margin-right: 10px;"></span>
                        </div>
                        <div style="display: flex; gap: 5px;">
                            <button onclick="exportCurrentChat()" style="padding: 8px 16px; font-size: 12px;">
                                ğŸ’¾ Export
                            </button>
                            <button onclick="clearCurrentChat()" class="danger" style="padding: 8px 16px; font-size: 12px;">
                                ğŸ—‘ï¸ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù†
                            </button>
                        </div>
                    </div>

                    <div class="chat-box" id="chatBox">
                        <div class="empty-state">
                            <h3>Ù‡Ù†ÙˆØ² Ú†ØªÛŒ Ø´Ø±ÙˆØ¹ Ù†Ø´Ø¯Ù‡!</h3>
                            <p>Ø§Ø¨ØªØ¯Ø§ Agent Ø±Ø§ Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ú©Ù†ÛŒØ¯ Ùˆ ÛŒÚ© Ú†Øª Ø¬Ø¯ÛŒØ¯ Ø´Ø±ÙˆØ¹ Ú©Ù†ÛŒØ¯</p>
                        </div>
                    </div>

                    <div class="input-section">
                        <input type="text" id="messageInput" 
                               placeholder="Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯..." 
                               onkeypress="handleKeyPress(event)" disabled>
                        <button onclick="sendMessage()" id="sendBtn" disabled>Ø§Ø±Ø³Ø§Ù„</button>
                    </div>

                    <button onclick="initAgent()" id="initBtn" style="width: 100%; margin-top: 10px;">
                        ğŸš€ Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ Agent
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { Agentify } from '../agentify/index.js';

        let agent = null;
        let currentChatId = null;

        window.initAgent = async function() {
            const apiKey = prompt('Ú©Ù„ÛŒØ¯ API Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:');
            if (!apiKey) return;

            try {
                agent = new Agentify({
                    provider: 'openai',
                    apiUrl: 'https://api.openai.com/v1/chat/completions',
                    apiKey: apiKey,
                    model: 'gpt-4',
                    stream: true,
                    useHistory: true,
                    maxHistoryMessages: 50,
                    includeHistory: true
                });

                agent.setInstruction('Ø´Ù…Ø§ ÛŒÚ© Ø¯Ø³ØªÛŒØ§Ø± Ù‡ÙˆØ´Ù…Ù†Ø¯ Ù‡Ø³ØªÛŒØ¯ Ú©Ù‡ Ø¯Ø± Ú¯ÙØªÚ¯ÙˆÙ‡Ø§ÛŒ Ø·ÙˆÙ„Ø§Ù†ÛŒ Ø¨Ù‡ Ø®Ø§Ø·Ø± Ø³Ù¾Ø±Ø¯Ù† ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ú©Ø§Ù…Ù„ ØªÙˆØ§Ù†Ø§ÛŒÛŒ Ø¯Ø§Ø±ÛŒØ¯.');

                document.getElementById('messageInput').disabled = false;
                document.getElementById('sendBtn').disabled = false;
                document.getElementById('initBtn').style.display = 'none';

                refreshChatList();
                updateStats();

                alert('Agent Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª!');

            } catch (error) {
                alert('Ø®Ø·Ø§: ' + error.message);
            }
        };

        window.createNewChat = async function() {
            if (!agent) {
                alert('Ø§Ø¨ØªØ¯Ø§ Agent Ø±Ø§ Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ú©Ù†ÛŒØ¯');
                return;
            }

            const title = prompt('Ø¹Ù†ÙˆØ§Ù† Ú†Øª Ø¬Ø¯ÛŒØ¯:') || 'Ú†Øª Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†';
            
            currentChatId = agent.generateNewChatId();
            agent.setChatId(currentChatId);
            agent.clearHistory(); // Clear current session

            document.getElementById('chatBox').innerHTML = '';
            document.getElementById('currentChatTitle').textContent = title;
            document.getElementById('currentChatId').textContent = `(${currentChatId.substring(0, 12)}...)`;

            addMessage('Ú†Øª Ø¬Ø¯ÛŒØ¯ Ø´Ø±ÙˆØ¹ Ø´Ø¯!', 'assistant');
            
            refreshChatList();
            updateStats();
        };

        window.sendMessage = async function() {
            if (!agent || !currentChatId) {
                alert('Ø§Ø¨ØªØ¯Ø§ ÛŒÚ© Ú†Øª Ø¬Ø¯ÛŒØ¯ Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù†ÛŒØ¯');
                return;
            }

            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            if (!message) return;

            addMessage(message, 'user');
            input.value = '';
            input.disabled = true;

            try {
                let response = '';
                const messageDiv = addMessage('', 'assistant');

                await agent.chat(message, {
                    chatId: currentChatId,
                    onToken: (token) => {
                        response += token;
                        messageDiv.querySelector('.message-content').textContent = response;
                    },
                    onComplete: () => {
                        updateStats();
                        refreshChatList();
                    }
                });

            } catch (error) {
                console.error('Error:', error);
                addMessage('Ø®Ø·Ø§: ' + error.message, 'assistant');
            } finally {
                input.disabled = false;
                input.focus();
            }
        };

        window.loadChat = async function(chatId) {
            if (!agent) return;

            currentChatId = chatId;
            agent.setChatId(chatId);

            const history = agent.getChatHistory(chatId);
            
            document.getElementById('chatBox').innerHTML = '';
            document.getElementById('currentChatTitle').textContent = `Ú†Øª ${chatId.substring(0, 8)}`;
            document.getElementById('currentChatId').textContent = `(${chatId.substring(0, 12)}...)`;

            history.messages.forEach(msg => {
                addMessage(msg.content, msg.role, new Date(msg.timestamp));
            });

            updateStats();
            
            // Highlight active chat
            document.querySelectorAll('.chat-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.chatId === chatId) {
                    item.classList.add('active');
                }
            });
        };

        window.refreshChatList = function() {
            if (!agent) return;

            const chatIds = agent.getAllHistoryChatIds();
            const chatList = document.getElementById('chatList');

            if (chatIds.length === 0) {
                chatList.innerHTML = '<p style="text-align: center; color: #6c757d; padding: 20px;">Ú†ØªÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯...</p>';
                return;
            }

            chatList.innerHTML = chatIds.map(chatId => {
                const messageCount = agent.getChatMessageCount(chatId);
                const metadata = agent.getChatHistory(chatId).metadata;
                
                return `
                    <div class="chat-item ${chatId === currentChatId ? 'active' : ''}" 
                         data-chat-id="${chatId}" 
                         onclick="loadChat('${chatId}')">
                        <div class="chat-item-title">
                            ğŸ’¬ Ú†Øª ${chatId.substring(0, 8)}...
                        </div>
                        <div class="chat-item-info">
                            ${messageCount} Ù¾ÛŒØ§Ù… â€¢ ${new Date(metadata.updatedAt).toLocaleDateString('fa-IR')}
                        </div>
                    </div>
                `;
            }).join('');
        };

        window.updateStats = function() {
            if (!agent) return;

            const stats = agent.getChatHistoryStats();
            
            document.getElementById('totalChats').textContent = stats.totalChats;
            document.getElementById('totalMessages').textContent = stats.totalMessages;
            document.getElementById('storageUsed').textContent = stats.storageUsedFormatted;
            
            if (currentChatId) {
                const count = agent.getChatMessageCount(currentChatId);
                document.getElementById('currentMessages').textContent = count;
            }
        };

        window.updateSettings = function() {
            if (!agent) return;

            const useHistory = document.getElementById('useHistory').checked;
            const includeHistory = document.getElementById('includeHistory').checked;
            const maxHistory = parseInt(document.getElementById('maxHistory').value);

            agent.setUseHistory(useHistory);
            agent.setIncludeHistory(includeHistory);
            agent.setMaxHistoryMessages(maxHistory);
        };

        window.exportCurrentChat = function() {
            if (!agent || !currentChatId) return;

            const format = prompt('ÙØ±Ù…Øª Export (json/text/markdown/html):', 'json');
            if (!format) return;

            const data = agent.exportChatHistory(currentChatId, format);
            
            const blob = new Blob([data], { 
                type: format === 'json' ? 'application/json' : 'text/plain' 
            });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `chat-${currentChatId.substring(0, 8)}.${format}`;
            a.click();
            URL.revokeObjectURL(url);

            alert('Ú†Øª Export Ø´Ø¯!');
        };

        window.clearCurrentChat = function() {
            if (!agent || !currentChatId) return;

            if (confirm('Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø§ÛŒÙ† Ú†Øª Ø±Ø§ Ù¾Ø§Ú© Ú©Ù†ÛŒØ¯ØŸ')) {
                agent.clearChatHistory(currentChatId);
                
                document.getElementById('chatBox').innerHTML = '<div class="empty-state"><h3>Ú†Øª Ù¾Ø§Ú© Ø´Ø¯!</h3></div>';
                currentChatId = null;
                
                refreshChatList();
                updateStats();
            }
        };

        window.handleKeyPress = function(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                sendMessage();
            }
        };

        function addMessage(text, role, timestamp = new Date()) {
            const chatBox = document.getElementById('chatBox');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.textContent = text;
            
            const timeDiv = document.createElement('div');
            timeDiv.className = 'message-time';
            timeDiv.textContent = timestamp.toLocaleTimeString('fa-IR');
            
            messageDiv.appendChild(contentDiv);
            messageDiv.appendChild(timeDiv);
            
            chatBox.appendChild(messageDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
            
            return messageDiv;
        }

        // Auto update stats
        setInterval(() => {
            if (agent) {
                updateStats();
            }
        }, 5000);
    </script>
</body>
</html>
