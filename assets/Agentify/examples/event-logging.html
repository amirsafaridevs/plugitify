<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agentify.js - Event Logging</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .content {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 0;
            min-height: 600px;
        }

        .sidebar {
            background: #f8f9fa;
            padding: 20px;
            border-left: 1px solid #e9ecef;
            overflow-y: auto;
            max-height: 700px;
        }

        .main {
            padding: 20px;
        }

        .chat-section {
            margin-bottom: 20px;
        }

        .chat-box {
            height: 250px;
            overflow-y: auto;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background: #f8f9fa;
        }

        .message {
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 8px;
        }

        .message.user {
            background: #667eea;
            color: white;
            margin-right: 20%;
        }

        .message.assistant {
            background: white;
            border: 2px solid #e9ecef;
            margin-left: 20%;
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .input-group input {
            flex: 1;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
        }

        button {
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        button:hover {
            transform: translateY(-2px);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 12px;
            opacity: 0.9;
        }

        .event-list {
            max-height: 550px;
            overflow-y: auto;
        }

        .event-item {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            font-size: 13px;
        }

        .event-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .event-type {
            font-weight: bold;
            color: #667eea;
            font-size: 11px;
            text-transform: uppercase;
        }

        .event-time {
            color: #6c757d;
            font-size: 11px;
        }

        .event-data {
            background: #f8f9fa;
            padding: 8px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 11px;
            max-height: 100px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .chat-id {
            background: #fff3cd;
            color: #856404;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            display: inline-block;
            margin-top: 5px;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .controls button {
            flex: 1;
            min-width: 120px;
        }

        .filter-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .filter-section h4 {
            margin-bottom: 10px;
            color: #495057;
        }

        .filter-section select {
            width: 100%;
            padding: 8px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“Š Event Logging Ø³ÛŒØ³ØªÙ…</h1>
            <p>Ø°Ø®ÛŒØ±Ù‡ Ùˆ Ù…Ø¯ÛŒØ±ÛŒØª ØªÙ…Ø§Ù… Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ÛŒ Ø³ÛŒØ³ØªÙ…</p>
        </div>

        <div class="content">
            <div class="sidebar">
                <div class="filter-section">
                    <h4>ÙÛŒÙ„ØªØ± Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§</h4>
                    <select id="eventTypeFilter" onchange="filterEvents()">
                        <option value="">Ù‡Ù…Ù‡ Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§</option>
                        <option value="user_message_sent">Ù¾ÛŒØ§Ù… Ú©Ø§Ø±Ø¨Ø±</option>
                        <option value="assistant_message_completed">Ù¾Ø§Ø³Ø® Ù…Ø¯Ù„</option>
                        <option value="tool_call_initiated">Ø´Ø±ÙˆØ¹ Ø§Ø¨Ø²Ø§Ø±</option>
                        <option value="tool_call_completed">Ø§ØªÙ…Ø§Ù… Ø§Ø¨Ø²Ø§Ø±</option>
                        <option value="api_request_sent">Ø¯Ø±Ø®ÙˆØ§Ø³Øª API</option>
                        <option value="api_response_received">Ù¾Ø§Ø³Ø® API</option>
                        <option value="error_occurred">Ø®Ø·Ø§</option>
                    </select>
                    
                    <select id="chatIdFilter" onchange="filterEvents()">
                        <option value="">Ù‡Ù…Ù‡ Ú†Øªâ€ŒÙ‡Ø§</option>
                    </select>
                </div>

                <div class="controls">
                    <button onclick="refreshEvents()">ğŸ”„ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ</button>
                    <button onclick="exportEvents()">ğŸ’¾ Export</button>
                    <button onclick="clearEvents()" style="background: #dc3545;">ğŸ—‘ï¸ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù†</button>
                </div>

                <div class="event-list" id="eventList">
                    <p style="text-align: center; color: #6c757d; padding: 20px;">
                        Ù‡Ù†ÙˆØ² Ø±ÙˆÛŒØ¯Ø§Ø¯ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡...
                    </p>
                </div>
            </div>

            <div class="main">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="totalEvents">0</div>
                        <div class="stat-label">Ú©Ù„ Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="currentChatId">-</div>
                        <div class="stat-label">Chat ID ÙØ¹Ù„ÛŒ</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="storageUsed">0 KB</div>
                        <div class="stat-label">ÙØ¶Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø´Ø¯Ù‡</div>
                    </div>
                </div>

                <div class="chat-section">
                    <h3 style="margin-bottom: 15px;">ğŸ’¬ Ú¯ÙØªÚ¯Ùˆ Ø¨Ø§ Agent</h3>
                    
                    <div class="chat-box" id="chatBox">
                        <p style="color: #6c757d; text-align: center;">
                            Ø§Ø¨ØªØ¯Ø§ Agent Ø±Ø§ Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ Ú©Ù†ÛŒØ¯...
                        </p>
                    </div>

                    <div class="input-group">
                        <input type="text" id="messageInput" 
                               placeholder="Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯..." 
                               onkeypress="handleKeyPress(event)" disabled>
                        <button onclick="sendMessage()" id="sendBtn" disabled>Ø§Ø±Ø³Ø§Ù„</button>
                        <button onclick="newChat()">Ú†Øª Ø¬Ø¯ÛŒØ¯</button>
                    </div>

                    <button onclick="initAgent()" style="width: 100%;">
                        ğŸš€ Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ Agent
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { Agentify, EventTypes } from '../agentify/index.js';

        let agent = null;
        let currentFilter = {};

        window.initAgent = async function() {
            const apiKey = prompt('Ú©Ù„ÛŒØ¯ API Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:');
            if (!apiKey) return;

            try {
                agent = new Agentify({
                    provider: 'openai',
                    apiUrl: 'https://api.openai.com/v1/chat/completions',
                    apiKey: apiKey,
                    model: 'gpt-4',
                    stream: true
                });

                agent.setInstruction('Ø´Ù…Ø§ ÛŒÚ© Ø¯Ø³ØªÛŒØ§Ø± Ù‡ÙˆØ´Ù…Ù†Ø¯ Ù‡Ø³ØªÛŒØ¯.');

                // Add a sample tool
                await agent.addTool({
                    name: 'get_time',
                    description: 'Ø¯Ø±ÛŒØ§ÙØª Ø²Ù…Ø§Ù† ÙØ¹Ù„ÛŒ',
                    parameters: {},
                    execute: async () => {
                        return {
                            time: new Date().toLocaleTimeString('fa-IR'),
                            date: new Date().toLocaleDateString('fa-IR')
                        };
                    }
                });

                document.getElementById('messageInput').disabled = false;
                document.getElementById('sendBtn').disabled = false;

                addChatMessage('Agent Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª! Ø´Ø±ÙˆØ¹ Ú©Ù†ÛŒØ¯...', 'assistant');
                
                refreshEvents();
                updateChatIds();

            } catch (error) {
                alert('Ø®Ø·Ø§: ' + error.message);
            }
        };

        window.sendMessage = async function() {
            if (!agent) return;

            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            if (!message) return;

            addChatMessage(message, 'user');
            input.value = '';

            try {
                let response = '';
                const messageDiv = addChatMessage('', 'assistant');

                await agent.chat(message, {
                    onToken: (token) => {
                        response += token;
                        messageDiv.textContent = response;
                    },
                    onToolCall: (toolCall) => {
                        console.log('Tool called:', toolCall.name);
                    },
                    onComplete: () => {
                        refreshEvents();
                    }
                });

            } catch (error) {
                console.error('Error:', error);
                addChatMessage('Ø®Ø·Ø§: ' + error.message, 'assistant');
            }
        };

        window.newChat = function() {
            if (!agent) return;
            
            const newChatId = agent.generateNewChatId();
            document.getElementById('chatBox').innerHTML = '';
            addChatMessage(`Ú†Øª Ø¬Ø¯ÛŒØ¯ Ø´Ø±ÙˆØ¹ Ø´Ø¯ (${newChatId.substring(0, 15)}...)`, 'assistant');
            
            updateChatIds();
            refreshEvents();
        };

        window.refreshEvents = function() {
            if (!agent) return;

            const events = agent.getEvents(currentFilter);
            const stats = agent.getEventStats();

            // Update stats
            document.getElementById('totalEvents').textContent = stats.totalEvents;
            document.getElementById('storageUsed').textContent = stats.storageUsedFormatted;
            
            const currentChatId = agent.getCurrentChatId();
            document.getElementById('currentChatId').textContent = 
                currentChatId ? currentChatId.substring(0, 8) + '...' : '-';

            // Display events
            const eventList = document.getElementById('eventList');
            if (events.length === 0) {
                eventList.innerHTML = '<p style="text-align: center; color: #6c757d; padding: 20px;">Ø±ÙˆÛŒØ¯Ø§Ø¯ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯...</p>';
                return;
            }

            eventList.innerHTML = events.reverse().map(event => `
                <div class="event-item">
                    <div class="event-header">
                        <span class="event-type">${getEventTypeLabel(event.type)}</span>
                        <span class="event-time">${escapeHtml(event.time)}</span>
                    </div>
                    ${event.chatId ? `<div class="chat-id">Chat: ${escapeHtml(event.chatId.substring(0, 12))}...</div>` : ''}
                    <div class="event-data">${formatEventData(event)}</div>
                </div>
            `).join('');
        };

        window.filterEvents = function() {
            const typeFilter = document.getElementById('eventTypeFilter').value;
            const chatIdFilter = document.getElementById('chatIdFilter').value;

            currentFilter = {};
            if (typeFilter) currentFilter.type = typeFilter;
            if (chatIdFilter) currentFilter.chatId = chatIdFilter;

            refreshEvents();
        };

        window.exportEvents = function() {
            if (!agent) return;

            const jsonData = agent.exportEvents('json', currentFilter);
            const blob = new Blob([jsonData], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `events-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);

            alert('Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Export Ø´Ø¯Ù†Ø¯!');
        };

        window.clearEvents = function() {
            if (!agent) return;
            
            if (confirm('Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ù‡Ù…Ù‡ Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ Ø±Ø§ Ù¾Ø§Ú© Ú©Ù†ÛŒØ¯ØŸ')) {
                agent.clearEvents();
                refreshEvents();
                alert('Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ Ù¾Ø§Ú© Ø´Ø¯Ù†Ø¯!');
            }
        };

        window.handleKeyPress = function(event) {
            if (event.key === 'Enter') sendMessage();
        };

        function addChatMessage(text, role) {
            const chatBox = document.getElementById('chatBox');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            messageDiv.textContent = text;
            chatBox.appendChild(messageDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
            return messageDiv;
        }

        function updateChatIds() {
            if (!agent) return;

            const chatIds = agent.getChatIds();
            const select = document.getElementById('chatIdFilter');
            
            select.innerHTML = '<option value="">Ù‡Ù…Ù‡ Ú†Øªâ€ŒÙ‡Ø§</option>';
            chatIds.forEach(chatId => {
                const option = document.createElement('option');
                option.value = chatId;
                option.textContent = chatId.substring(0, 20) + '...';
                select.appendChild(option);
            });
        }

        // HTML escape function to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function getEventTypeLabel(type) {
            const labels = {
                'user_message_sent': 'ğŸ“¤ Ù¾ÛŒØ§Ù… Ú©Ø§Ø±Ø¨Ø±',
                'assistant_message_started': 'ğŸ¤– Ø´Ø±ÙˆØ¹ Ù¾Ø§Ø³Ø®',
                'assistant_message_completed': 'âœ… Ù¾Ø§Ø³Ø® Ú©Ø§Ù…Ù„',
                'tool_call_initiated': 'ğŸ”§ Ø´Ø±ÙˆØ¹ Ø§Ø¨Ø²Ø§Ø±',
                'tool_call_completed': 'âœ”ï¸ Ø§ØªÙ…Ø§Ù… Ø§Ø¨Ø²Ø§Ø±',
                'tool_call_failed': 'âŒ Ø®Ø·Ø§ÛŒ Ø§Ø¨Ø²Ø§Ø±',
                'api_request_sent': 'ğŸ“¡ Ø¯Ø±Ø®ÙˆØ§Ø³Øª API',
                'api_response_received': 'ğŸ“¥ Ù¾Ø§Ø³Ø® API',
                'thinking_started': 'ğŸ§  Ø´Ø±ÙˆØ¹ ØªÙÚ©Ø±',
                'error_occurred': 'âš ï¸ Ø®Ø·Ø§',
                'stream_started': 'âš¡ Ø´Ø±ÙˆØ¹ Stream'
            };
            return labels[type] || escapeHtml(type);
        }

        function formatEventData(event) {
            const data = event.data;
            
            if (event.type === 'user_message_sent') {
                const message = data.message || '';
                const truncated = message.substring(0, 50);
                return `Ù¾ÛŒØ§Ù…: ${escapeHtml(truncated)}${message.length > 50 ? '...' : ''}`;
            } else if (event.type === 'assistant_message_completed') {
                const message = data.message || 'N/A';
                const truncated = message.substring(0, 50);
                return `Ù¾Ø§Ø³Ø®: ${escapeHtml(truncated)}${message.length > 50 ? '...' : ''}\nØ·ÙˆÙ„: ${data.messageLength} Ú©Ø§Ø±Ø§Ú©ØªØ±\nØ²Ù…Ø§Ù†: ${data.duration}ms`;
            } else if (event.type === 'tool_call_completed') {
                return `Ø§Ø¨Ø²Ø§Ø±: ${escapeHtml(data.toolName)}\nÙ¾Ø§Ø±Ø§Ù…ØªØ±Ù‡Ø§: ${escapeHtml(JSON.stringify(data.parameters))}\nÙ†ØªÛŒØ¬Ù‡: ${escapeHtml(JSON.stringify(data.result).substring(0, 100))}`;
            } else if (event.type === 'api_request_sent') {
                return `Endpoint: ${escapeHtml(data.endpoint)}\nBody Size: ${data.bodySize} bytes`;
            }
            
            return escapeHtml(JSON.stringify(data, null, 2).substring(0, 200));
        }

        // Auto refresh every 2 seconds
        setInterval(() => {
            if (agent) {
                refreshEvents();
            }
        }, 2000);
    </script>
</body>
</html>
